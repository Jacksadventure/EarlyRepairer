# EarlyRepairer

EarlyRepairer is a grammar-based string repair tool that attempts to automatically fix malformed inputs by applying a small number of edits and validating candidates with an external "oracle" parser. This project includes:
- A C++ repair engine (`earlyrepairer.cpp` → `earlyrepairer`).
- A JSON oracle executable (`cjson/cjson`) used to validate candidate strings.
- Example input/output files (`test.json`, `output.json`).

It is optimized for JSON recovery, but the approach is generic and can be adapted to other languages with a suitable oracle.

## Key Features

- Grammar covering approach with insertion/deletion/substitution edit operators.
- Multi-edit search up to a configurable limit (default MAX_EDITS=5).
- Position-unique terminal boxing to align edits with intuitive string-level minimal edits (e.g., deleting a trailing character is truly one edit).
- Oracle-driven validation with timeout and call budgets.
- Restricted insertion charset when the oracle path suggests JSON.

## How It Works

1. The tool treats the input string as a sequence of terminals and constructs a base grammar.
2. It builds a "covering grammar" which augments each terminal position with a position-unique "box" nonterminal enabling:
   - Match the original char
   - Delete the char
   - (Optional) Substitute via a negative-class rule
   - (Optional) Insert via a wildcard before/after positions
3. It then searches through candidate strings generated by applying up to K edits (K=MAX_EDITS) and consults an oracle:
   - If the oracle returns success (exit code 0), the candidate is accepted and written to the output file.
   - The search is pruned (e.g., at most one char insertion/substitution per combination) to control combinatorics.

## Project Structure

- `earlyrepairer.cpp` — C++17 repair engine.
- `earlyrepairer` — Compiled binary (after building).
- `cjson/` — JSON oracle (binary at `cjson/cjson`, source and Makefile included).
- `test.json` — Example malformed input.
- `output.json` — Output written by `earlyrepairer` if a repair is found.

## Build

Requires a C++17 compiler (tested on macOS with `g++`).

Build the repairer:
```bash
g++ -std=c++17 -O2 -o earlyrepairer earlyrepairer.cpp
```

If you need to (re)build the JSON oracle and a Makefile is provided:
```bash
make -C cjson
```
(Or follow build steps appropriate to your environment.)

## Usage

```bash
./earlyrepairer <parser_path> <input_string_or_file> <output_file>
```

- `parser_path`: path to the oracle parser executable (e.g., `./cjson/cjson`).
- `input_string_or_file`: either a literal string to evaluate or a filesystem path to a file containing the input.
- `output_file`: where the repaired string will be written on success.

Example:
```bash
./earlyrepairer ./cjson/cjson ./test.json output.json
```

If a repair is found, you will see:
```
Repaired string: {...}
*** Number of required oracle runs: <total> correct: <ok> incorrect: <err> incomplete: <inc> ***
```

## Oracle Interface

The oracle is an external executable invoked as:
```
<parser_executable> <path_to_temp_input_file>
```

Expected exit codes:
- `0`: Valid input (OK)
- `1`: Invalid input (ERR)
- `255`: Incomplete/ambiguous (INC) — treated as non-OK by repairer
- Any other exit or signal is treated as an error

Timeout: each oracle run is killed if it exceeds 1000 ms.


## Configuration and Tuning

- `MAX_EDITS` (in `main`): maximum number of edits to try per derivation (default 5).
- `MAX_ORACLE` (global): hard cap on total oracle invocations (default 10000).
- `timeout_ms` (in `oracleWrap`): per-call timeout (default 1000 ms).
- Insertion charset: when the oracle path includes `json`, insertions are limited to a JSON-friendly character set to reduce search space.

To change `MAX_EDITS`, edit near the top of `main`:
```cpp
const int MAX_EDITS = 5; // adjust as needed
```

## Example

Input file (`test.json`):
```json
{"121234":"2"}1
```

Run:
```bash
./earlyrepairer ./cjson/cjson ./test.json output.json
```

Output:
```
Repaired string: {"121234":"2"}
*** Number of required oracle runs: 11 correct: 1 incorrect: 9 incomplete: 1 ***
```

The engine now performs a single deletion of the trailing `1` (position-unique boxing ensures it aligns with the intuitive minimal edit), leaving the key `"121234"` intact.

## Notes and Limitations

- The search attempts to find any acceptable repair within the edit budget; it is not guaranteed to find the globally minimal edit under all configurations, though the position-unique boxing significantly improves behavior with respect to string-level minimal edits.
- To control runtime, budgets (MAX_EDITS, MAX_ORACLE) and pruning heuristics are used. Increasing budgets may find more repairs but will cost time.
- The oracle must be deterministic and follow the exit-code contract above.

## Troubleshooting

- "No fix with up to X edits found":
  - Increase `MAX_EDITS`
  - Increase `MAX_ORACLE`
  - Relax timeouts
  - Ensure the oracle runs and is executable (`chmod +x`), and that it accepts a single path argument.
- Long runtimes:
  - Reduce `MAX_EDITS` or `MAX_ORACLE`
  - Keep JSON insertion charset restricted
  - Improve oracle performance or reduce timeout if it is too high

## License

No explicit license provided. Treat as internal code unless you add a license file.
